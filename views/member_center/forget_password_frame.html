<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
        <title>my</title>
        <link rel="stylesheet" type="text/css" href="../../css/api.css" />
        <style>
            html {
                height: 100%;
            }
            
            body {
                width: 100%;
                height: auto;
                min-height: 100%;
                background-color: #f0eff7;
            }
            
            .container {
                position: relative;
                -webkit-box-sizing: border-box;
                        box-sizing: border-box;
                top: 21px;
                padding-left: 16px;
                width: 100%;
                height: auto;
                overflow: hidden;
                border-top: 1px solid #bababa;
                border-bottom: 1px solid #bababa;
                background-color: #fff;
            }
            
            .container .row {
                position: relative;
                box-sizing: border-box;
                padding-right: 16px;
                top: -1px;
                display: -webkit-box;
                display: -webkit-flex;
                display: flex;
                -webkit-box-orient: horizontal;
                -webkit-flex-flow: row;
                flex-flow: row;
                width: 100%;
                height: 44px;
                border-top: 1px solid #bababa;
            }
            
            .container .row .name {
                box-sizing: border-box;
                width: 80px;
                height: 44px;
                color: #000;
                font-size: 16px;
                line-height: 44px;
                text-align: left;
            }
            
            .container .row .value {
                -webkit-box-flex: 1;
                -webkit-flex: 1;
                flex: 1;
                height: 44px;
            }
            
            .container .row .value input {
                box-sizing: border-box;
                padding-top: 15px;
                padding-bottom: 11px;
                width: 100%;
                vertical-align: middle;
                border: none;
                outline: none;
                font-size: 15px;
            }
            
            .container .account .code-button {
                height: 44px;
                width: 100px;
                font-size: 14px;
                color: #000;
                text-align: center;
                line-height: 44px;
            }
            
            .button {
                position: relative;
                top: 21px;
                margin-top: 36px;
                margin-left: 16px;
                margin-right: 16px;
                width: auto;
                height: 44px;
                color: #fff;
                font-size: 16px;
                line-height: 44px;
                text-align: center;
                background-color: #00aeef;
                border-radius: 8px;
            }
            
            .notice {
                position: relative;
                top: 21px;
                margin-top: 24px;
                width: 100%;
                height: 44px;
                color: #0f70bd;
                text-align: center;
                line-height: 44px;
                font-size: 14px;
            }
            
            .highlight {
                opacity: 0.7;
            }
            .sendingVerify {
                color: RGBA(0, 0, 0, 0.4);
            }
        </style>
    </head>

    <body>
      <!--   <section class="container">
            <div class="row account">
                <div class="name">Username</div>
                <div class="value">
                    <input id="account"  type="tel" value="" placeholder="Tel number">
                </div>
                <div class="code-button" tapmode="highlight" id="sendVerify" onclick="getVerify( this )">Get Captcha</div>
            </div>
            <div class="row">
                <div class="name">Captcha</div>
                <div class="value">
                    <input id="code" type="number" placeholder="Captcha">
                </div>
                <div class="holder"></div>
            </div>
            <div class="row">
                <div class="name">New</div>
                <div class="value">
                    <input id="password" type="password" value="" placeholder="Input the new password">
                </div>
                <div class="holder"></div>
            </div>
            <div class="row">
                <div class="name">Confirm </div>
                <div class="value">
                    <input id="repassword" type="password" value="" placeholder="Confirm the new password">
                </div>
                <div class="holder"></div>
            </div>
        </section>
        <div class="notice">The password needs at least 6 bits.</div>
        <div class="button" tapmode="highlight" onclick="fnSubmit()">Submit</div> -->
    </body>
     <script type="text/javascript" src="../../script/api.js"></script>
    <script type="text/javascript" src="../../script/ajaxRequest.js"></script>
<script type="text/javascript" src="../../script/languge.js"></script>
    <script type="text/javascript" src="../../script/md5.js"></script>
    <script type="text/javascript" src="../../script/translation.js"></script>
    <script type="text/javascript" src="../../script/languge.js"></script>
    <script type="text/javascript">
        apiready = function() {
            $api.dom('body').innerHTML=
            
    '    <section class="container">'+
    '        <div class="row account">'+
    '           <div class="name">'+fnLanguageSwitch('账号')+'</div>' +
    '            <div class="value">'+
    '              <input id="account"  type="tel" value="" placeholder="'+fnLanguageSwitch('请输入手机号码')+'">'+ 
    '            </div>'+
    '            <div class="code-button" tapmode="highlight" id="sendVerify"               onclick="getVerify( this )">'+fnLanguageSwitch('获取验证码')+'</div>'+
    '        </div>'+
    '        <div class="row">'+
    '            <div class="name">'+fnLanguageSwitch('验证码')+'</div>'+
    '            <div class="value">'+
    '                <input id="code" type="number" placeholder="'+fnLanguageSwitch('请输入收到的验证码')+'">'+
    '            </div>'+
    '            <div class="holder"></div>'+
    '        </div>'+
    '        <div class="row">'+
    '            <div class="name">'+fnLanguageSwitch('新密码')+'</div>'+
    '           <div class="value">'+
    '                <input id="password" type="password" value="" placeholder="'+fnLanguageSwitch('请输入新密码')+'">'+
    '            </div>'+
    '            <div class="holder"></div>'+
    '        </div>'+
    '        <div class="row">'+
    '            <div class="name">'+fnLanguageSwitch('确认密码')+'</div>'+
    '            <div class="value">'+
    '                <input id="repassword" type="password" value="" placeholder="'+fnLanguageSwitch('确认新密码')+'">'+
    '            </div>'+
    '            <div class="holder"></div>'+
    '        </div>'+
    '    </section>'+
    '    <div class="notice">'+fnLanguageSwitch('密码至少6位')+'</div>'+
    '    <div class="button" tapmode="highlight" onclick="fnSubmit()">'+fnLanguageSwitch('提交')+'</div>';
           


        };
        function fnSubmit(){
            var phone = $("#account").val();
            var verityCode = $("#code").val();
            var password = $("#password").val();
            var repassword = $("#repassword").val();
            if ($.trim(phone) === '') {
                api.toast({
          		    global: true,
          	      msg: fnLanguageSwitch( "手机号码不能为空")
                });
                return;
            }
            if (!validatePhoneNum(phone)) {
                api.toast({
          		    global: true,
          	      msg: fnLanguageSwitch( "手机号码格式不正确")
                });
                return;
            }
            if ($.trim(verityCode) === '') {
                api.toast({
          		    global: true,
          	      msg: fnLanguageSwitch( "验证码不能为空")
                });
                return;
            }
            if ($.trim(password) === '') {
                api.toast({
          		    global: true,
          	      msg: fnLanguageSwitch( "密码不能为空")
                });
                return;
            }
            if ($.trim(password).length < 6) {
                api.toast({
          		    global: true,
          	      msg: fnLanguageSwitch(" 密码至少6位")
                });
                return;
            }
            if ($.trim(repassword) === '') {
                api.toast({
          		    global: true,
          	      msg: fnLanguageSwitch("确认密码不能为空")
                });
                return;
            }
            if ($.trim(repassword).length < 6) {
                api.toast({
          		    global: true,
          	      msg: fnLanguageSwitch("确认密码至少6位")
                });
                return;
            }
            if (password != repassword) {
                api.toast({
          		    global: true,
          	      msg: fnLanguageSwitch("两次密码不一致")
                });
                return;
            }     
             api.showProgress();
//          忘记密码
            fnAjax({
                url: 'users/forget',
                data: {
                    values: {
                        cellPhone: $api.dom( '#account' ).value,
                        phone_captcha: $api.dom('#code').value,
                        password: $api.dom('#password').value
                    }
                }
            }, function( ret, err){
              //  debugAlert( arguments )
                if( ret ){
                    api.execScript({
                        name: 'login',
                        frameName: 'login_frame',
                        script: 'fnReLogin()'
                    });
                    api.toast({
                        global: true,
                        msg: fnLanguageSwitch('密码修改成功')
                    });
                    setTimeout(function(){
                        api.closeWin();
                    }, 1000);
                }else{
                    api.toast({
                        global: true,
                        msg: fnLanguageSwitch( fnErrorJson( err.body.error.message ) )
                    });
                }
            })

}

        // 这里开始重构
       //  return;
       //      var phone = $("#account").val();
       //      var verityCode = $("#code").val();
       //      var password = $("#password").val();
       //      var repassword = $("#repassword").val();
       //      if ($.trim(phone) === '') {
       //          api.toast({
	// global: true,location: 'top', msg: "Tel. cannot be empty."});
       //          return;
       //      }
       //      if (!validatePhoneNum(phone)) {
       //          api.toast({
	// global: true,location: 'top', msg: "The format of Tel. is incorrect."});
       //          return;
       //      }
       //      if ($.trim(verityCode) === '') {
       //          api.toast({
	// global: true,location: 'top', msg: "The verification code cannot be empty."});
       //          return;
       //      }
       //      if ($.trim(password) === '') {
       //          api.toast({
	// global: true,location: 'top', msg: "The password cannot be empty."});
       //          return;
       //      }
       //      if ($.trim(password).length < 6) {
       //          api.toast({
	// global: true,location: 'top', msg: "The password needs at least 6 bits."});
       //          return;
       //      }
       //      if ($.trim(repassword) === '') {
       //          api.toast({
	// global: true,location: 'top', msg: "The confirmed password cannot be empty."});
       //          return;
       //      }
       //      if ($.trim(repassword).length < 6) {
       //          api.toast({
	// global: true,location: 'top', msg: "The password needs at least 6 bits."});
       //          return;
       //      }
       //      if (password != repassword) {
       //          api.toast({
	// global: true,location: 'top', msg: "The passwords are inconsistent."});
       //          return;
       //      }
       //      var bodyParam = {
       //          LoginName:phone,
       //          CaptchaNo:verityCode,
       //          PassWord:MD5(password)
       //      };
       //      var url = 'APPUserInfo/UpdatePassword.aspx';
       //       api.showProgress({
       //          title: 'Loading...',
       //          text: '',
       //          modal: false
       //      });
       //      ajaxRequest(url,'get',bodyParam,function(ret,err){
       //          api.hideProgress();
       //          if(ret){
       //              if(ret.res==1){
       //                  api.alert({
       //                      title: 'Your password is modified successfully.',
       //                      msg: '',
       //                      buttons:['I got it.']
       //                  }, function (ret, err) {
                            // api.closeWin();
       //                  });
       //              }else{
       //               if( ret.des.indexOf( '验证码错误' ) !== -1 ){
       //                   ret.des = 'Wrong Verification Code';
       //               }
       //                  api.toast({
	                       // global:true,
       //                   location: 'top',
       //                      msg:ret.des
       //                  });
       //              }
       //          }else{
       //              api.toast({
	                     // global:true,
       //               location: 'top',
       //                  msg:err.msg
       //              });
       //          }
       //      })
       //  };
        function validatePhoneNum(phoneNum) {
            var myreg = /^(((1[0-9]{2}))+\d{8})$/;
            return myreg.test(phoneNum);
        }
        
        var eGetVerify = null;
        function getVerify( el ) {
//          获取手机验证码
            if( ! $api.hasCls(el, 'sendingVerify') ){
                var phone = $("#account").val();
                 if (!phone||$.trim(phone) == '') {
                    api.toast({
          		    global: true,
          	      msg: fnLanguageSwitch("手机号码不能为空")
                });
                                return;
                            }
                 if (!validatePhoneNum(phone)) {
                    api.toast({
          		    global: true,
          	      msg: fnLanguageSwitch("手机号码格式不正确")
                });
                    return;
                }
                 $api.addCls( el, 'sendingVerify' );
            fnAjax({
                url: 'randomCodes/getCodeByMobile',
                data: {
                    values: {
                        loginname: $api.dom( '#account' ).value,
                        type: 4
                    }
                },
                //debug: true
            }, function( ret, err){
                //debugAlert( arguments )
                if( ret){
                   CountDown( 60, el );
                    api.toast({
                        msg:fnLanguageSwitch('发送成功')
                    });
                }else{
                    $api.removeCls( el, 'sendingVerify' );
                    api.toast({
                        msg: fnLanguageSwitch( fnErrorJson( err.body.error.message ) )
                    });
                }
            })

     }
}
        // 这里开始重构
//         return;

//          if( ! $api.hasCls(el, 'sendingVerify') ){
//              var phone = $("#account").val();
//              if (!phone||$.trim(phone) == '') {
//                  api.toast({
	// global: true,location: 'top', msg: "Tel. cannot be empty."});
//                  return;
//              }
//              if (!validatePhoneNum(phone)) {
//                  api.toast({
	// global: true,location: 'top', msg: "The format of Tel. is incorrect."});
//                  return;
//              }
//              $api.addCls( el, 'sendingVerify' );
// //               $('#sendVerify').removeAttr('onclick').html('To Get <span id="getVerify">60</span>\'S ').addClass('sendingVerify');
               
//              var bodyParam = {
//                  LoginName:phone
//              }
//              var url = 'APPUserInfo/getCaptcha.aspx';
//              api.showProgress({
//                  title: 'Loading...',
//                  text: '',
//                  modal: false
//              });
//              ajaxRequest(url, 'get', bodyParam, function (ret, err) {
//                  api.hideProgress();
//                  if(ret&&ret.res==1){
//                      CountDown( 60, el );
//                      api.toast({
	// global: true,
//                          location: 'top',
//                          msg:'Send successfully'
//                      });
//                  }else{
//                      CountDown( 0, el );
//                      if( ret.des === '不存在此用户名' ){
//                          api.toast({
	// global: true,
//                              location: 'top',
//                              msg: 'The account does not exist, please input your registered username.'
//                          });
//                      }else{
//                          api.toast({
	// global: true,
//                              location: 'top',
//                              msg:'Fail to obtain the verification code'
//                          });
//                      }
//                  }
//              });
//             }
//         }
        var vTime = null;
        function CountDown( num, el) {
            if (num <= 0) {
                $( el ).html(fnLanguageSwitch('重新获取')).removeClass('sendingVerify');
                clearTimeout( vTime );
            }else{
                vTime = setTimeout(function(){
                    --num;
                    $( el ).html('<span>'+num+'</span>'+fnLanguageSwitch('秒后重发')+'');
                    CountDown( num, el);
                },1000);
            }
        }
    </script>

</html>
