<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>debug-frm</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" href="../../css/common.css">
    <style type="text/css">
        body {
            height: auto;
            min-height: 100%;
        }
        .common-part-service {

        }

        .whats-this {
            background-color: #F0F0F0;
            padding-top: 1.5rem;
        }

        .whats-this .this-name {
            font-size: 1.5rem;
            line-height: 2.5rem;
            color: #000000;
            background: url(../../image/project/icon_debug.png) 1rem 50% no-repeat;
            background-size: 2.5rem 2.5rem;
            text-indent: 4rem;
        }

        .whats-this .this-description {
            padding: 0.8rem 2.2rem 1rem 4rem;
            font-size: 1.3rem;
            line-height: 1.6rem;
            color: #515458;
            border-bottom: 0.2rem solid #C8C8C8;
        }

        .whats-this .design {
            padding-left: 4rem;
        }

        .whats-this .text, .whats-this .designer {
            font-size: 1.2rem;
            line-height: 2.6rem;
            color: #000000;
        }

        .whats-this .rank {

        }

        .whats-this .stars {
            color: #999999;
            font-size: 1.8rem;
            vertical-align: bottom;
            line-height: 2.6rem;
        }

        .whats-this .stars .fa-star {
            color: #FFDA00;
        }

        /*已选择的项目*/
        .project-header {
            padding: 0 1rem;
            background-color: #FFFFFF;
        }

        .project-header label {
            font-size: 1.6rem;
            line-height: 5.5rem;
        }

        .header-inner {
            width: 33.9rem;
            height: 8.4rem;
            border: 0.1rem solid #005BBC;
            border-radius: 0.6rem;
            position: relative;
        }

        .header-inner-img {
            position: absolute;
            left: 50%;
            margin-left: -1.6rem;
            top: -1.6rem;
            width: 3.2rem;
            height: 3.2rem;
            background: #FFFFFF url(../../image/project/project_list_icon.png) center center no-repeat;
            background-size: 1.9rem 2.2rem;
        }

        .header-inner .name {
            font-size: 1.5rem;
            color: #005BBC;
            text-align: center;
            line-height: 3rem;
            padding-top: 1.3rem;
            font-weight: bold;
        }

        .header-inner .date-group {
            position: absolute;
            left: 0;
            bottom: 0;
        }

        .header-inner .date-group .text, .header-inner .date-group .date {
            font-size: 1.2rem;
            line-height: 2.1rem;
            color: #000000;
            padding-left: 1rem;
        }

        .header-inner .date-counting {
            width: 11.7rem;
            margin: 0 auto;
            text-align: center;
            color: #F7AA00;
            font-size: 1.2rem;
        }

        .header-inner .date-counting .count {
            font-size: 2.8rem;
            line-height: 4rem;
        }

        .header-inner .project-state {
            position: absolute;
            right: 0;
            bottom: 0.6rem;
            font-size: 1.2rem;
            line-height: 2rem;
            padding-right: 0.5rem;
        }

        .project-header .create-group {
            font-size: 1.3rem;
            line-height: 4.5rem;
            text-align: right;
            color: #595C60;
        }

        .project-header .create-group .btn-create {
            background-color: #0071C5;
            border-radius: 0.3rem;
            width: 10.9rem;
            height: 2.8rem;
            color: #FFFFFF;
            text-align: center;
            line-height: 2.8rem;
        }

        /*大体上通用的部分 end*/
        .propose-title{
            height: 3.7rem;
            line-height: 3.7rem;
            font-size: 1.5rem;
            background-color: #DBF0FF;
            color: #0271C5;
            background-image: url("../../image/project/icon_quote_right.png");
            background-position-x: 1rem;
            background-position-y: center;
            background-repeat: no-repeat;
            background-size: 2rem;
            padding-left: 3.8rem;
            font-weight: bold;
        }

        .propose-note {
            padding: 10px;
            position: relative;
            color: #696D70;
            font-size: 1.5rem;
        }

        .propose-select, .textareaLabel, .fileuploadLabel {
            height: 4rem;
            line-height: 4rem;
            padding-left: 10px;
            font-size: 1.6rem;
            position: relative;
        }
        .propose-select span{
            position: absolute;
            color: #A1A1A1;
            right: 10px;
        }

        .textWrap {
            height: 10rem;
            background-color: #ffffff;
            margin: 0 10px;
            border: 1px solid #D6D6D6;
            display: -webkit-box;
        }

        textarea {
            display: block;
            -webkit-box-flex: 1;
            resize: none;
            padding: 10px;
            font-size: 14px;
        }

        .image-list {
            height: 85px;
            background-size: cover;
            padding: 10px 10px;
            overflow: hidden;
        }

        .image-item.space {
            border: none;
        }

        .image-item {
            width: 65px;
            height: 65px;
            background-image: url(../../image/project/add_pic.png);
            background-size: 100% 100%;
            display: inline-block;
            position: relative;
            margin-right: 10px;
            margin-bottom: 10px;
            border: solid 1px #e8e8e8;
        }

        .image-item .image-close {
            position: absolute;
            display: inline-block;
            right: -6px;
            top: -6px;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            border-radius: 12px;
            background-color: #FF5053;
            color: #f3f3f3;
            border: solid 1px #FF5053;
            font-size: 9px;
            font-weight: 200;
            z-index: 1;
        }

        .image-item.space .image-close {
            display: none;
        }

        .image-item input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 0;
        }

        input, textarea {
            border: none !important;
        }
        
        /*upload start*/
        .upload-group{
            position: relative;
            margin-bottom: 3rem;
            padding-left: 1rem;
        }
        .upload-label{
            color: #000000;
            font-size: 1.1rem;
            padding: 1rem;
            padding-left: 0;
            line-height: 1.4rem;
        }
        .upload-group img{
            width: 7.7rem;
            height: 7.7rem;
        }
        .upload-group .image-name{
            position: absolute;
            left: 9.2rem;
            bottom: 3.5rem;
            font-size: 0.9rem;
            color: #999999;
            line-height: 1.9rem;
        }
        .upload-group .notice{
            position: absolute;
            left: 9.2rem;
            bottom: 0;
            font-size: 0.9rem;
            color: #999999;
            line-height: 1.9rem;
        }
        /*upload end*/
        .submitWrap {
            text-align: center;
            margin-top: 4rem;
            padding-bottom: 4rem;
            height: 4rem;
            line-height: 4rem;
        }

        .submitWrap span {
            width: 18rem;
            height: 3.8rem;
            /*margin: 3rem auto;*/
            text-align: center;
            color: #FFFFFF;
            background-color: #0071C5;
            border-radius: 0.4rem;
            line-height: 3.8rem;
            font-size: 1.6rem;
        }
    </style>
</head>
<body>
<div class="common-part-service">
    <div class="whats-this">
        <p class="this-name">
            Debug
        </p>

        <p class="this-description">
            Do you want to debug for your project? 
Please use the submitted information for this project to get the debug supports from professional engineers.。
            We will contact you the first time when the application for Debug is submitted.
        </p>

        <div class="design">
            <span class="text">Designer：</span>
				<span class="designer">
					
				</span>

            <div class="rank">
                <span class="text">Satisfaction：</span>
					<span class="stars">
	                    <!-- <i class="fa-star fa"></i>
	                    <i class="fa-star fa"></i>
	                    <i class="fa-star fa"></i>
	                    <i class="fa-star fa"></i>
	                    <i class="fa-star fa"></i> -->
	                </span>
                <span class="text"></span>
            </div>
        </div>
    </div>
    <div class="project-header">
        <label>The project you have selected：</label>

        <div class="header-inner">
            <div class="header-inner-img"></div>
            <p class="name"></p>

            <div class="header-bottom">
                <div class="date-group">
                    <p class="text">Project starts at</p>

                    <p class="date"></p>
                </div>
                <div class="date-counting">
                    <span class="count"></span>
                    day
                </div>
                <div class="project-state"></div>
            </div>
        </div>
        <p class="create-group">
            If you are not applying support for this project, please first
            <span class="btn-create" tapmode onclick="createNewProject()">add new project</span>
        </p>
    </div>
</div>

<div class="propose">
    <div class="propose-title border-1px-top border-1px-bottom">
        Please fill out the form
    </div>
    <div class="propose-note">
       Now we provide the phone communication services for the clients, the support staff will send suggestions via email within 3 days, if we are not get response after 3 days, the system will close this support. If you want more related problem supports, please re-open this support.
    </div>
    <div class="propose-select border-1px-top border-1px-bottom">
        This debug belongs to
        <span class="question-type" tapmode onclick="openQuestionType(this)">---Select---</span>
    </div>
    <div class="textareaLabel">
        Problem description and experiment result:
    </div>
    <div class="textWrap">
        <textarea id="textarea"></textarea>
    </div>
    <div class="fileuploadLabel">
        Please upload image of trouble:
    </div>
    <div class="upload-group">
        <img id="upload_img" src="../../image/project/add_pic.png" data-url="" alt="" tapmode onclick="chooseGetType(this)">
        <p class="image-name ellepsis-1">No uploaded images</p>
        <p class="notice ellepsis-1">Schematic Review require to upload images (maximum 10M)</p>
    </div>
    <div class="submitWrap">
        <span class="btn" id="submit" tapmode onclick="fnSubmit(this)">
            Submit
        </span>
    </div>
</div>
<div id="modal_selector" tapmode="" onclick="selectCancel()">
    <div class="select">
        <div class="select-control">
            <div class="select-control-cancel" tapmode="" onclick="selectCancel()">Cancel</div>
            <div class="select-control-placeHolder"></div>
            <div class="select-control-ok" tapmode="" onclick="selectCancel()">Done</div>
        </div>
        <div class="select-content">

        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/ajaxRequest.js"></script>
<script type="text/javascript" src="../../script/languge.js"></script>
<script type="text/javascript" src="../../script/translation.js"></script>
<script type="text/javascript">

    // 以下通用
    var account = $api.getStorage('loginInfo');
    var pageParam = {};
    var projectID = '';
    var typeid = 7;
    var UICustomPicker;
    var zhuge;
    apiready = function () {
        pageParam = api.pageParam;
        UICustomPicker = api.require('UICustomPicker');
        projectID = pageParam.id;
        zhuge = api.require('zhuge');
        if (zhuge) {
            zhuge.initZhuge();
        }
        getProjectDetail();
        getProjectDesigner();
    };

    function getProjectDesigner(){
        ajaxRequest('/APPSupportManage/GetSupportAppraise.aspx', 'get', {
            UserID: account.userid,
            BatchNo: account.batchno, 
            SupportTypeID: typeid
        }, function(ret, err){
            if(ret && ret.res == undefined){
                // console.log('ret:normal===='+ JSON.stringify(ret));
                var data = ret.appdatalist[0];
                $api.html($api.dom('.designer'), data.UserName);
                
                var len = parseInt(data.EvaluateNumber);
                var str = '';
                for (var i = 0; i < len; i++) {
                    str+= '<i class="fa-star fa"></i>';
                }
                $api.html($api.dom('.stars'), str);
                $api.html($api.domAll('.rank .text')[1], '('+ data.UserNum +'Person)');
            } else{
                console.log('ret:err===='+ JSON.stringify(ret));
            }
            if (err) {
                console.log('err===='+ JSON.stringify(err));
            }

        });
        
    };

    function getProjectDetail(){
        ajaxRequest('/APPProjectManage/APPGetProjectDetail.aspx', 'get', {
            UserID: account.userid,
            BatchNo: account.batchno,
            ProjectID: projectID
        }, function(ret, err){
            if(ret && ret.res == undefined){
                var data = ret.appdatalist[0];
                $api.html($api.dom('.project-header .header-inner .name'), data.ProjectName);
                $api.html($api.dom('.project-header .header-inner .date'), data.CreateDate);
                $api.html($api.dom('.project-header .header-inner .count'), data.ProjectStartDay);
                $api.html($api.dom('.project-header .header-inner .project-state'), 'In '+ ( fnTranslation(data.ProjectStatus, true) ) +' stage');
                
            } else{
                console.log('ret:err===='+ JSON.stringify(ret));
            }
            if (err) {
                console.log('err===='+ JSON.stringify(err));
            }
        });
    };
    // 以上通用

    function openQuestionType(el){
        // ---Choose---
        // Hardware related
        // 软件OS，driver...
        // BIOS, FW related
        // 其他
        var data = [{
            value: '---Select---',
            id: 0
        },{
            value: 'Hardware related',
            id: 0
        },{
            value: 'Software OS, Driver related',
            id: 0
        },{
            value: 'BIOS, FW related',
            id: 0
        },{
            value: 'Others',
            id: 0
        }];
        openSelector(el, data);

    };

    var uploadImg = $api.dom('#upload_img');
    // 获取图片方式选择
    function chooseGetType(){
        api.actionSheet({
            title: 'Select',
            cancelTitle: 'Cancel',
            buttons: ['Photo upload', 'Album']
        },function(ret,err){
            if (ret.buttonIndex == 1) {
                getPicture('camera');
            } else if(ret.buttonIndex == 2){
                getPicture('library');
            }
        });
    };

    // 获取图片
    function getPicture(type){
        // library camera
        api.getPicture({
            sourceType: type,
            encodingType: 'png',
            mediaValue: 'pic',
            destinationType: 'url',
            allowEdit: true,
            quality: 50,
            targetWidth: 400,
            targetHeight: 400,
            saveToPhotoAlbum: false
        }, function(ret, err){ 
            if (ret && ret.data) {
                $api.attr(uploadImg, 'src', ret.data);
                $api.attr(uploadImg, 'data-url', ret.data);
                $api.html($api.dom($api.closest(uploadImg, '.upload-group'), '.image-name'), ret.data.substring(ret.data.lastIndexOf('/') + 1));
            }
        });
    };


    // 提交debug
    var textarea = $api.dom('#textarea');
    var questionType = $api.dom('.question-type');

    var submitLock = false;
    function fnSubmit(el){

        var QuestionType = $api.trim($api.text(questionType));
        if (QuestionType == '---Select---') {
            api.alert({
                title: 'Notice', 
                msg: 'Please select the type of problem',
                        buttons: ['I got it.']

            });
            return false;
        }
        var DescriptionAndResults = $api.trim($api.val(textarea));
        if (DescriptionAndResults == '') {
            api.alert({
                title: 'Notice', 
                msg: 'Please fill in the problem description and experiment result',
                        buttons: ['I got it.']

            });
            return false;
        }
        var Photo = $api.attr(uploadImg, 'data-url');
        if (Photo == '') {
            api.alert({
                title: 'Notice', 
                msg: 'Please upload image of trouble',
                        buttons: ['I got it.']
                
            });
            return false;
        }


        if (submitLock) {
            return false;
        } else {
            submitLock = true;
            $api.attr(el, 'disabled', 'disabled');
        }

        if (zhuge) {
            zhuge.track({
                eventName: '项目支持_技术支持提交按钮',
                eventPro: {
                    '模块来源': 'Debug'
                }
            });
        }
        ajaxRequest('/APPSupportManage/APPSupportDebugServe.aspx', 'post', {
            UserID: account.userid,
            BatchNo: account.batchno,
            ItemNameID: projectID,
            QuestionType: QuestionType,
            DescriptionAndResults: DescriptionAndResults
        }, {
            Photo: Photo
        }, function(ret, err){
            submitLock = false;
            $api.removeAttr(el, 'disabled');
            if(ret && ret.res){
                // console.log('ret:normal===='+ JSON.stringify(ret));
                api.toast({
	global: true,
                    msg: 'The request for Debug has been submitted successfully.',
                    duration: 2000,
                    location: 'middle'
                });
                setTimeout(function(){
                    api.closeWin();
                },2000);
            } else{
                api.toast({
	global: true,
                    msg: JSON.stringify(ret),
                    duration: 2000,
                    location: 'middle'
                });
            }
            if (err) {
                api.toast({
	global: true,
                    msg: JSON.stringify(err),
                    duration: 2000,
                    location: 'middle'
                });
            }
        });

    };
    // 调用selector
    var UICustomPickerElement,
        UICustomPickerId,
        selectorValue,
        selectorId,
        blurInput = $api.domAll('input'),
        blurText = $api.domAll('textarea');

    function openSelector(el, data){
        for (var i = 0; i < blurInput.length; i++) {
            blurInput[i].blur();
        }
        for (var j = 0; j < blurText.length; j++) {
            blurText[j].blur();
        }
        var scope = data;
        UICustomPickerElement = el;
        $api.addCls($api.dom('body'), 'selector-modal-show');
        var UICustomPickerContentOffset = $api.offset($api.dom('.select-content'));

        UICustomPicker.open({
            rect: {
                x: 0,
                y: api.frameHeight - UICustomPickerContentOffset.h,
                h: UICustomPickerContentOffset.h
            },
            styles: {
                bg: 'rgba(0,0,0,0)',
                normalColor: '#959595',
                selectedColor: '#3685dd',
                selectedSize: 30,
                tagColor: '#3685dd',
                tagSize: 10
            },
            data: [{
                scope: scope
            }],
            autoHide: false,
            rows: 5,
            fixedOn: api.frameName,
            fixed: true
        }, function( ret, err ){
            UICustomPickerId = ret.id;
            if(ret){
                // console.log( JSON.stringify( ret ) );
                if(ret.eventType=='show'){
                    selectorValue = scope[0].value;
                    selectorId = scope[0].id;
                }else{
                    selectorValue = ret.data[0].value;
                    selectorId = ret.data[0].id;
                }
                selectOK();
            }
        });
    };
    function selectCancel() {
        UICustomPicker.close({
            id: UICustomPickerId
        });
        $api.removeCls($api.dom('body'), 'selector-modal-show');
        if( event ){event.cancelBubble = true;}
        return false;
    };

    function selectOK() {
        if (UICustomPickerElement.tagName.toLowerCase() == 'input') {
            $api.val(UICustomPickerElement, selectorValue);
            $api.attr(UICustomPickerElement, 'data-selectorid', selectorId);
        } else {
            $api.html(UICustomPickerElement, selectorValue);
            $api.attr(UICustomPickerElement, 'data-selectorid', selectorId);
        }
        if( event ){event.cancelBubble = true;}
        return false;
    };
</script>
</html>